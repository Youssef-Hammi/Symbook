{% extends 'base.html.twig' %}

{% block title %}Paiement par carte{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1>Paiement de la commande #{{ order.id }}</h1>

    <p>Montant total : {{ order.totalPrice|number_format(2, '.', ',') }} â‚¬</p>

    <form id="payment-form">
        <div id="card-element"><!-- Stripe Elements will be injected here --></div>

        <!-- Used to display form errors -->
        <div id="card-errors" role="alert" class="text-danger mt-3"></div>

        <button id="submit-button" class="btn btn-success mt-4">Payer</button>
    </form>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripePublicKey }}');
    const elements = stripe.elements();
    const cardElement = elements.create('card');

    cardElement.mount('#card-element');

    const form = document.getElementById('payment-form');
    const cardErrors = document.getElementById('card-errors');
    const submitButton = document.getElementById('submit-button');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        submitButton.disabled = true;

        const { error, paymentIntent } = await stripe.confirmCardPayment('{{ clientSecret }}', {
            payment_method: {
                card: cardElement,
                //billing_details: { // Optional: Add billing details if you collect them }
            }
        });

        if (error) {
            // Show error to your customer (e.g., insufficient funds)
            cardErrors.textContent = error.message;
            submitButton.disabled = false;
        } else {
            // The payment has been processed!
            if (paymentIntent.status === 'succeeded') {
                // Show a success message to your customer
                // There's a risk of the customer closing the window before callback
                // execution. Set up a webhook to listen for the PaymentIntent s.succeeded event
                // and fulfill any orders after the event. For example, see https://stripe.com/docs/payments/handling-payment-events

                // Redirect to a success page or order history
                window.location.href = '{{ path('order_history') }}'; // Redirect to order history after successful payment

            } else {
                 // Handle any other PaymentIntent status or show error
                 cardErrors.textContent = 'Payment failed with status: ' + paymentIntent.status;
                 submitButton.disabled = false;
            }
        }
    });
</script>
{% endblock %} 